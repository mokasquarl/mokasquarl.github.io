---
layout: 
title: Burrows-Wheeler, Coronavirus, & Bayes --- Building a Bioinformatics Pipleline to Detect & Understand Coronavirus Mutations
---
![cool 3d renderings showing mutant & normal virus spike structure ](/images/file.png "looks nice mang")

As the pandemic runs its course, tracking genetic mutations has gained mainstream coverage. Officially, in the line of work we call bioinformatics finding and understanding mutations is known as *Variant Calling*. In the same way every person is different from others (except twins), an individual virus can have variations in their genome; when a lot of these genetic variants accumlate between the virus we detected originally and what we find months later in a faraway town, we can say that we have a new *strain* of the virus. The Coronavirus which we're now calling *SARS-CoV-2* was first detected in Wuhan中国, so the genetic sequecing data from here is used as the base reference genome, and we measure mutations for the virus detected everywhere else against this; a coronavirus genome from a few towns away might only have a couple letters of the genome different from the Wuhan data, while something that's travelled to the other side of the world after being transmitted through many people, climates, and even treatments, might now have acquired many more genetic variants compared to the original data.

| SRA | ENA | GISAID |
|-------|--------|---------|
| Sequence Read Archive | European Nucleotide Archive | Global Initiative on Sharing Avian Influenza Data |
| All Species | All Species | Viral Only |
| Open Access | Open Access | Private |

Data from viruses sequenced all across the world are uploaded into one of several databases (Table 1), this data is generated directly from machines by Illumina, Oxford Nanopore, or Life Technologies. When turning the molecules in genetic code into digital files these machines create strings that can be a few hundered letters in length to several thousand, but never the enitre genome of the virus in a single string. A standardized file format called *fastq* holds all the strings from a single sample, including some quality data from the machine doing the sequencing. These strings are in no particular order, and first need to be mapped together to get the complete genome. Pretty much the standard way to create these genetic maps uses a technique invented in Palo Alto back in the early 90s by  Michael Burrows and David Wheeler. The *Burrows–Wheeler Transform* was mostly just used in data compression, until after 2010 when computational biologists began to use it to align genomes together.

Heng Li, now a professor at Harvard (amongst other things) has created the most commonly used alignment algorithm (amongst other things) with [BWA](https://github.com/lh3/bwa). This algorithm is super easy to use, and will get us results that are more than good enough. 

    git clone https://github.com/lh3/bwa.git
    cd bwa
    make

BWA takes **fastq** files containing samples, along with a *fasta* file containing a reference gemone to map the strings contained in our **fastq** file (fig 1). Refernce genomes are usually put out by the scientific wing of a National Goverment, Regional Organizations, and some Universities. We'll get our Wuhan Coronavirus Refernce genome from the National Center for Biotechnology Information (https://www.ncbi.nlm.nih.gov/nuccore/1798174254)hosted by the US Federal government.A good sample to run against the Wuhan reference is Washington state outbreak that happened early in the US, the *fastq* data for this is also hosted by the NCBI at their Sequence Read Archive (https://trace.ncbi.nlm.nih.gov/Traces/sra/?run=SRR11278092). 

![gif of terminal commands running the alignment ](/images/file.png "running bwa is super easy")

In the animated terminal above we see the commands needed to create our mapped genome from our input files, including retriving the data from the databases . If you'd like to skip all that, we're hosting both the reference genome, and the completed alignment map over at [Lucid Align](https://lucidalign.com/#cov). We'll be using the ***bam** file to detect our mutations, and we can also browse the genome of this Washington state outbreak sample using any sequence alignment viewer.

But before going on to variant calling this first sample let's just prepare another sample while we're making these alignment maps. Let's do a more recent outbreak, from Kent, UK; which is far from Wuhan & the Washington sample, in both time & space. Retriving the samples from European Nucleotide Archive can be done from this [link](https://www.ebi.ac.uk/ena/browser/view/ERR4659819)or from the shell. 

    git clone https://github.com/enasequence/enaBrowserTools.git
    cd python3
    enaDataGet.py -f fastq -m -d [output_directory] ERR4659819

BWA

In this post we use the reference genome established by the CDC: [Severe acute respiratory syndrome coronavirus 2 isolate Wuhan-Hu-1, complete genome.](https://www.ncbi.nlm.nih.gov/nuccore/1798174254) To begin we need to grab just the *FASTA* data and save it as a file under something like **nCoVref.fasta** 

Next we will use samtools to index this reference file.

    git clone https://github.com/samtools/samtools.git
    
    cd samtools
    ./configure
    make
    make install
    
    ./samtools faidx nCoVref.fasta

This creates our **nCoVref.fasta.fai** index file, which will be useful later. To perform our actual alignment we are going to use the Burrow-Wheeler Aligner for short-reads, BWA. 

    git clone https://github.com/lh3/bwa.git
    cd bwa
    make
    ./bwa index nCoVref.fasta
    
BWA index created some additional files, like *.bwt, .pac, .ann*, and others. Now our reference genome is ready to align reads from sequencing data of patients from outbreaks. We are going to use isolate raw read files from the Washington SARS-CoV-2 outbreak uploaded to the [Sequence Read Archive.](https://trace.ncbi.nlm.nih.gov/Traces/sra/?run=SRR11278092)To retrieve this data we need to use the SRA Toolkit, whose compiled binaries/install scripts can be found [Here](https://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=software). Once installed we grab our reads:

    ./fastq-dump --outdir /path SRR11278092
    
We should now have a **SRR11278092.fastq** file. Which can be used with our previously prepared nCoVref file.

    ./bwa mem nCoVref.fasta SRR11278092.fastq > SARS-CoV-2_align.sam
    ./samtools view -bS SRR11278092.sam | samtools sort - SARS-CoV-2_align_sorted
    
Our output from the last few steps should be a **SARS-CoV-2_align_sorted.bam** file. This file also needs to be indexed so that we can navigate it quickly:

    ./samtools index SARS-CoV-2_align_sorted.bam
    
Samtools can be used to view the alignment maps just created:

    ./samtools tview SARS-CoV-2_align_sorted.bam nCoVref.fasta

![samtools tview](/images/tview.png "SARS-CoV-2 Aligned")

Tview can be very slow and difficult to use for anything other than a quick look because terminal has a difficult time rendering all the charecters and colors. Below are two external tools we can use, including one that I work on. 
[![Lucid Align](/images/lucid.png "SARS-CoV-2 Aligned MacOS")](https://lucidalign.com)

[Lucid](https://lucidalign.com) is much faster than using the terminal, and doesn't have any problems rendering the data since it's written in C#. However, [The Integrative Genomics Viewer (IGV)](http://software.broadinstitute.org/software/igv/) is really the academic standard when it comes navigating sequence alignments. Although it's not as quick or pretty, it has many more esoteric features which can be helpful to niche projects.

Using these viewers is only the first use of the reference & alignments we prepared. It's helpful in looking directly at specific mutations, and genes with a human eye. But at scale we will need to use variant callers, and maybe go back and forth between an automated process and some manual inspection. We can already see some mutations between the reference genome from the Wuhan samples to the alignments from Washington. Will try to post about scaling up & variant calling soon.

Happy Virus Hunting!
